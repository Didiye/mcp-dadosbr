# üîç Code Review Completo - MCP DadosBR

**Data:** 30/09/2025  
**Vers√£o Analisada:** 0.2.0 (branch: feature/sequential-thinking-search)  
**Revisor:** An√°lise Automatizada + Manual

---

## üìä Sum√°rio Executivo

- **Total de Issues Identificados:** 13
- **Cr√≠ticos (üî¥):** 3
- **Altos (üü°):** 6  
- **M√©dios/Baixos (üü¢):** 4
- **Issues Corrigidos:** 3
- **Issues Pendentes:** 10

**Prioridade de Corre√ß√£o:** CR√çTICO ‚Üí ALTO ‚Üí M√âDIO ‚Üí BAIXO

---

## üî¥ CR√çTICO - Issues de Seguran√ßa e Concorr√™ncia

### ‚úÖ Issue #1: Circuit Breaker N√£o Thread-Safe [CORRIGIDO]

**Arquivo:** `lib/core/http-client.ts:6-8`  
**Severidade:** üî¥ CR√çTICA  
**Status:** ‚úÖ **CORRIGIDO**

**Problema:**
```typescript
// ‚ùå Vari√°veis globais mut√°veis sem sincroniza√ß√£o
let failures = 0;
let lastFailure = 0;
let cbState: "CLOSED" | "OPEN" = "CLOSED";
```

**Impacto:**
- Race conditions em requisi√ß√µes concorrentes
- Contagem incorreta de falhas
- Estados inconsistentes do circuit breaker
- Pode causar falhas em cascata n√£o detectadas

**Solu√ß√£o Implementada:**
- ‚úÖ Novo arquivo: `lib/infrastructure/http/circuit-breaker.ts`
- ‚úÖ Implementa√ß√£o thread-safe como classe
- ‚úÖ Estado HALF_OPEN implementado
- ‚úÖ M√©tricas encapsuladas
- ‚úÖ 35 testes unit√°rios criados

**C√≥digo Corrigido:**
```typescript
export class CircuitBreaker {
  private failures = 0;
  private lastFailureTime = 0;
  private state: CircuitState = 'CLOSED';
  // ... estado encapsulado
}
```

---

### Issue #2: Cache N√£o Thread-Safe

**Arquivo:** `lib/core/cache.ts:4-9`  
**Severidade:** üü° M√âDIA  
**Status:** ‚ö†Ô∏è **PENDENTE**

**Problema:**
```typescript
// ‚ùå Map sem synchronization
private cache = new Map<string, CacheEntry>();
private accessOrder = new Map<string, number>();
```

**Impacto:**
- Corrup√ß√£o de dados em ambiente multi-threaded
- Perda de entradas do cache
- LRU incorreto sob concorr√™ncia

**Solu√ß√£o Recomendada:**
```typescript
import { AsyncLock } from 'async-mutex';

export class ThreadSafeMemoryCache implements Cache {
  private cache = new Map<string, CacheEntry>();
  private accessOrder = new Map<string, number>();
  private lock = new AsyncLock();
  
  async get(key: string): Promise<any | null> {
    return this.lock.runExclusive(async () => {
      // ... opera√ß√£o at√¥mica
    });
  }
}
```

**Depend√™ncia adicional:**
```bash
npm install async-mutex
```

---

### ‚úÖ Issue #3: Secrets em Logs [CORRIGIDO]

**Arquivo:** `lib/core/intelligence.ts`, `lib/core/tools.ts`  
**Severidade:** üü° M√âDIA  
**Status:** ‚úÖ **CORRIGIDO**

**Problema:**
```typescript
// ‚ö†Ô∏è Logs podem expor dados sens√≠veis
console.error(`[intelligence] [${options.cnpj}] Company: ${companyData.razao_social}`);
```

**Impacto:**
- Vazamento de CNPJ, raz√£o social, CPF de s√≥cios
- Dados sens√≠veis em arquivos de log
- Viola√ß√£o de LGPD

**Solu√ß√£o Implementada:**
- ‚úÖ Novo arquivo: `lib/infrastructure/telemetry/logger.ts`
- ‚úÖ Sanitiza√ß√£o autom√°tica de PII
- ‚úÖ M√°scaramento de CNPJ: `00.000.***/$$01-91`
- ‚úÖ Remo√ß√£o de API keys, tokens, emails, CPF, telefones
- ‚úÖ M√©todo conveniente `logger.cnpjOperation()`

**Exemplo de Uso:**
```typescript
import { logger } from '../infrastructure/telemetry/logger';

// Automaticamente mascara dados sens√≠veis
logger.cnpjOperation('lookup', '00.000.000/0001-91', {
  status: 'success',
  company: 'Banco do Brasil S.A.'
});

// Output: { cnpj: '00.000.***/$$01-91', ... }
```

---

## ‚ö° ALTO - Problemas de Performance

### Issue #4: Rate Limiting por Inst√¢ncia

**Arquivo:** `lib/core/search-providers.ts:21-23`  
**Severidade:** üü° M√âDIA  
**Status:** ‚ö†Ô∏è **PENDENTE**

**Problema:**
```typescript
// ‚ùå Rate limit n√£o √© global entre inst√¢ncias
private lastRequestTime = 0;
private minRequestInterval = 3000;
```

**Impacto:**
- M√∫ltiplas inst√¢ncias podem violar rate limits externos
- Ban por DuckDuckGo
- Perda de funcionalidade

**Solu√ß√£o Recomendada:**
```typescript
// Usar KV storage ou Redis para rate limiting global
export class GlobalRateLimiter {
  constructor(private storage: KVNamespace | RedisClient) {}
  
  async checkLimit(key: string, intervalMs: number): Promise<boolean> {
    const lastRequest = await this.storage.get(key);
    if (lastRequest && Date.now() - parseInt(lastRequest) < intervalMs) {
      return false;
    }
    await this.storage.put(key, Date.now().toString());
    return true;
  }
}
```

---

### Issue #5: Sem Timeout Total

**Arquivo:** `lib/core/intelligence.ts:65-75`  
**Severidade:** üü° M√âDIA  
**Status:** ‚ö†Ô∏è **PENDENTE**

**Problema:**
```typescript
// ‚ùå Loop pode demorar indefinidamente
for (const dork of selectedDorks) {
  await provider.search(dork.query, maxResultsPerQuery);
}
```

**Impacto:**
- Opera√ß√µes podem travar por minutos
- Timeout de MCP client (30s default)
- M√° experi√™ncia do usu√°rio

**Solu√ß√£o Recomendada:**
```typescript
export async function executeIntelligence(
  options: IntelligenceOptions,
  apiConfig: ApiConfig,
  cache?: Cache
): Promise<LookupResult> {
  const TOTAL_TIMEOUT_MS = 25000; // 25s (antes do timeout do MCP)
  
  const timeoutPromise = new Promise((_, reject) => 
    setTimeout(() => reject(new TimeoutError('Intelligence search timed out', TOTAL_TIMEOUT_MS)), 
    TOTAL_TIMEOUT_MS)
  );
  
  const searchPromise = (async () => {
    // ... l√≥gica existente
  })();
  
  return Promise.race([searchPromise, timeoutPromise]);
}
```

---

### Issue #6: Cleanup Ineficiente

**Arquivo:** `lib/core/cache.ts:35-42`  
**Severidade:** üü° M√âDIA  
**Status:** ‚ö†Ô∏è **PENDENTE**

**Problema:**
```typescript
// ‚ö†Ô∏è O(n) a cada opera√ß√£o de get/set
private cleanup(): void {
  const now = Date.now();
  for (const [key, entry] of this.cache.entries()) {
    if (now > entry.expires) {
      this.cache.delete(key);
    }
  }
}
```

**Impacto:**
- Degrada performance com cache grande (256+ entries)
- Cada get/set faz full scan
- Pode adicionar 10-50ms de lat√™ncia

**Solu√ß√£o Recomendada:**
```typescript
// Op√ß√£o 1: Lazy expiration (n√£o cleanup proativo)
get(key: string): any | null {
  const entry = this.cache.get(key);
  if (!entry) return null;
  
  if (Date.now() > entry.expires) {
    this.cache.delete(key);
    this.accessOrder.delete(key);
    return null;
  }
  
  return entry.data;
}

// Op√ß√£o 2: Background cleanup com intervalo
private startBackgroundCleanup(): void {
  setInterval(() => this.cleanup(), 60000); // 1 min
}
```

---

## üêõ M√âDIO - Bugs e Code Smells

### Issue #7: Silenciar Erros

**Arquivo:** `lib/core/search-providers.ts:60-63`  
**Severidade:** üü° M√âDIA  
**Status:** ‚ö†Ô∏è **PENDENTE**

**Problema:**
```typescript
// ‚ùå Retorna [] em vez de propagar erro
catch (error: any) {
  console.error(`[DuckDuckGo] Search failed: ${error.message}`);
  return [];
}
```

**Impacto:**
- Falhas silenciosas dif√≠ceis de debugar
- Usu√°rio n√£o sabe por que n√£o h√° resultados
- Logs ignorados em produ√ß√£o

**Solu√ß√£o Recomendada:**
```typescript
import { Result, NotFoundError, RateLimitError } from '../../shared/types/result';

async search(query: string, maxResults: number = 5): Promise<Result<SearchResult[], Error>> {
  await this.rateLimit();

  try {
    const searchResults = await duckSearch(query, {
      safeSearch: 0,
      locale: 'br-br'
    });

    const limitedResults = searchResults.results.slice(0, maxResults);
    const mapped = limitedResults.map(r => ({
      title: r.title || '',
      url: r.url || '',
      snippet: r.description || ''
    }));
    
    return Result.ok(mapped);
  } catch (error: any) {
    if (error.message?.includes('429') || error.message?.includes('detected an anomaly')) {
      return Result.err(new RateLimitError('DuckDuckGo rate limit exceeded'));
    }
    return Result.err(error);
  }
}
```

---

### Issue #8: SerpAPI N√£o Implementado

**Arquivo:** `lib/core/search-providers.ts:130-138`  
**Severidade:** üü¢ BAIXA  
**Status:** ‚ö†Ô∏è **PENDENTE**

**Problema:**
```typescript
// ‚ùå Feature anunciada mas n√£o funciona
async search(query: string, maxResults: number = 5): Promise<SearchResult[]> {
  console.warn('[SerpAPI] Not yet implemented');
  return [];
}
```

**Impacto:**
- Documenta√ß√£o enganosa
- Usu√°rios esperam funcionalidade que n√£o existe
- C√≥digo morto

**Solu√ß√£o 1: Implementar**
```typescript
async search(query: string, maxResults: number = 5): Promise<SearchResult[]> {
  if (!this.apiKey) {
    throw new Error('SerpAPI key not configured');
  }

  const response = await fetch(
    `https://serpapi.com/search?q=${encodeURIComponent(query)}&api_key=${this.apiKey}&num=${maxResults}`
  );
  
  const data = await response.json();
  
  return data.organic_results.map((r: any) => ({
    title: r.title,
    url: r.link,
    snippet: r.snippet
  }));
}
```

**Solu√ß√£o 2: Remover**
- Remover `SerpAPIProvider` completamente
- Atualizar documenta√ß√£o
- Remover de `ProviderType`

---

### Issue #9: Valida√ß√£o Fraca

**Arquivo:** `lib/core/dork-templates.ts:14-17`  
**Severidade:** üü° M√âDIA  
**Status:** ‚ö†Ô∏è **PENDENTE**

**Problema:**
```typescript
// ‚ö†Ô∏è Aceita m√∫ltiplos formatos sem valida√ß√£o
const cnpj = cnpjData.cnpj || cnpjData.taxId || '';
const razaoSocial = cnpjData.razao_social || cnpjData.company?.name || '';
```

**Impacto:**
- Bugs sutis com APIs diferentes
- Dorks mal formados
- Falhas silenciosas

**Solu√ß√£o Recomendada:**
```typescript
import { z } from 'zod';

const CnpjDataSchema = z.union([
  // OpenCNPJ format
  z.object({
    cnpj: z.string(),
    razao_social: z.string(),
    nome_fantasia: z.string().optional(),
    qsa: z.array(z.object({
      nome_socio: z.string()
    })).optional()
  }),
  // CNPJA format
  z.object({
    taxId: z.string(),
    company: z.object({
      name: z.string(),
      members: z.array(z.object({
        person: z.object({
          name: z.string()
        })
      })).optional()
    })
  })
]);

export function buildDorks(cnpjData: unknown, categories?: DorkCategory[]): DorkTemplate[] {
  // Validate and normalize
  const validated = CnpjDataSchema.parse(cnpjData);
  
  // Normalize to single format
  const normalized = 'cnpj' in validated ? {
    cnpj: validated.cnpj,
    razaoSocial: validated.razao_social,
    nomeFantasia: validated.nome_fantasia,
    socios: validated.qsa?.map(s => s.nome_socio) || []
  } : {
    cnpj: validated.taxId,
    razaoSocial: validated.company.name,
    nomeFantasia: '',
    socios: validated.company.members?.map(m => m.person.name) || []
  };
  
  // Build dorks with normalized data
  // ...
}
```

---

### Issue #10: Magic Numbers

**Arquivo:** V√°rios  
**Severidade:** üü¢ BAIXA  
**Status:** ‚ö†Ô∏è **PENDENTE**

**Problemas:**
```typescript
// lib/core/search-providers.ts:23
private minRequestInterval = 3000; // 3 seconds

// lib/core/http-client.ts:8
const circuitBreaker = new CircuitBreaker({
  failureThreshold: 5,
  resetTimeoutMs: 30000,
  halfOpenMaxAttempts: 3,
});

// lib/core/cache.ts:8
constructor(maxSize = 256, ttl = 60000) {
```

**Solu√ß√£o Recomendada:**
```typescript
// lib/shared/utils/constants.ts
export const CONFIG = {
  RATE_LIMIT: {
    DUCKDUCKGO_INTERVAL_MS: 3000,
    TAVILY_INTERVAL_MS: 0,
  },
  CIRCUIT_BREAKER: {
    FAILURE_THRESHOLD: 5,
    RESET_TIMEOUT_MS: 30000,
    HALF_OPEN_MAX_ATTEMPTS: 3,
  },
  CACHE: {
    DEFAULT_SIZE: 256,
    DEFAULT_TTL_MS: 60000,
  },
  TIMEOUTS: {
    HTTP_REQUEST_MS: 8000,
    INTELLIGENCE_TOTAL_MS: 25000,
  }
} as const;
```

---

### Issue #11: Error Handling Inconsistente

**Arquivos:** V√°rios  
**Severidade:** üü° M√âDIA  
**Status:** ‚úÖ **PARCIALMENTE CORRIGIDO** (Result type criado)

**Problema:**
- `tools.ts` retorna `{ ok: false, error }`
- `search-providers.ts` lan√ßa exceptions
- `search-providers.ts` retorna `[]`

**Solu√ß√£o Implementada:**
- ‚úÖ Criado `lib/shared/types/result.ts`
- ‚ö†Ô∏è C√≥digo existente ainda n√£o migrado

**Pr√≥ximos Passos:**
1. Migrar todas as fun√ß√µes para usar `Result<T, E>`
2. Remover pattern `{ ok: boolean }`
3. Padronizar error types

---

### Issue #12: Falta de Type Safety

**Arquivos:** V√°rios  
**Severidade:** üü¢ BAIXA  
**Status:** ‚ö†Ô∏è **PENDENTE**

**Problemas:**
```typescript
catch (error: any) { }
const socio: any = ...
private kv: any
```

**Solu√ß√£o Recomendada:**
```typescript
// Usar unknown em vez de any
catch (error: unknown) {
  const err = error instanceof Error ? error : new Error(String(error));
}

// Tipar corretamente
const socio: Socio = ...
private kv: KVNamespace
```

---

### Issue #13: Depend√™ncia Circular Potencial

**Arquivos:** `lib/core/tools.ts`, `lib/core/search.ts`, `lib/core/intelligence.ts`  
**Severidade:** üü¢ BAIXA  
**Status:** ‚ö†Ô∏è **PENDENTE**

**Problema:**
- Importa√ß√µes circulares podem causar `undefined` em runtime

**Solu√ß√£o:** Reorganiza√ß√£o arquitetural (ver se√ß√£o abaixo)

---

## ‚úÖ Melhorias Implementadas

### 1. Circuit Breaker Thread-Safe
- ‚úÖ Arquivo: `lib/infrastructure/http/circuit-breaker.ts`
- ‚úÖ 100+ linhas de c√≥digo
- ‚úÖ Estados: CLOSED, OPEN, HALF_OPEN
- ‚úÖ M√©tricas encapsuladas
- ‚úÖ 35 testes unit√°rios

### 2. Result<T, E> Type
- ‚úÖ Arquivo: `lib/shared/types/result.ts`
- ‚úÖ Functional error handling
- ‚úÖ Domain errors: ValidationError, NotFoundError, RateLimitError, etc
- ‚úÖ Helpers: map, flatMap, match, unwrap

### 3. Logger com PII Sanitization
- ‚úÖ Arquivo: `lib/infrastructure/telemetry/logger.ts`
- ‚úÖ M√°scaramento autom√°tico de CNPJ, CPF, emails
- ‚úÖ Remo√ß√£o de API keys e tokens
- ‚úÖ M√©todos convenientes: `cnpjOperation()`, `apiCall()`

### 4. Suite de Testes
- ‚úÖ Framework: Vitest 2.0
- ‚úÖ Configura√ß√£o: `vitest.config.ts`
- ‚úÖ 35 testes para Circuit Breaker
- ‚úÖ Coverage thresholds: 80% lines, 75% branches

---

## üèóÔ∏è Reorganiza√ß√£o Arquitetural Recomendada

**Status:** ‚ö†Ô∏è PLANEJADO (n√£o implementado por tempo)

### Estrutura Proposta

```
lib/
‚îú‚îÄ‚îÄ domain/              # Regras de neg√≥cio puras
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ repositories/   # Interfaces (ports)
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ
‚îú‚îÄ‚îÄ application/         # Casos de uso
‚îÇ   ‚îú‚îÄ‚îÄ use-cases/
‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ
‚îú‚îÄ‚îÄ infrastructure/      # Implementa√ß√µes t√©cnicas
‚îÇ   ‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îú‚îÄ‚îÄ http/
‚îÇ   ‚îú‚îÄ‚îÄ search-providers/
‚îÇ   ‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îî‚îÄ‚îÄ telemetry/
‚îÇ
‚îú‚îÄ‚îÄ presentation/        # Interfaces externas
‚îÇ   ‚îú‚îÄ‚îÄ mcp/
‚îÇ   ‚îú‚îÄ‚îÄ cli/
‚îÇ   ‚îú‚îÄ‚îÄ http/
‚îÇ   ‚îî‚îÄ‚îÄ cloudflare/
‚îÇ
‚îî‚îÄ‚îÄ shared/             # C√≥digo compartilhado
    ‚îú‚îÄ‚îÄ types/
    ‚îú‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ config/
```

**Benef√≠cios:**
- ‚úÖ Separation of Concerns
- ‚úÖ Testabilidade
- ‚úÖ Dependency Rule
- ‚úÖ Manutenibilidade

---

## üìä M√©tricas de Qualidade

### Antes das Corre√ß√µes
- **Thread Safety:** ‚ùå Circuit breaker n√£o thread-safe
- **Security:** ‚ö†Ô∏è PII em logs
- **Error Handling:** ‚ö†Ô∏è Inconsistente
- **Tests:** ‚ö†Ô∏è Apenas testes manuais
- **Code Coverage:** 0%

### Depois das Corre√ß√µes
- **Thread Safety:** ‚úÖ Circuit breaker corrigido
- **Security:** ‚úÖ Logger com sanitiza√ß√£o
- **Error Handling:** üü° Result type criado (migra√ß√£o pendente)
- **Tests:** ‚úÖ 35 unit tests, framework configurado
- **Code Coverage:** üéØ Target 80%+ (a medir)

---

## üìã Checklist de Corre√ß√µes

### Implementadas ‚úÖ
- [x] Circuit Breaker thread-safe
- [x] Logger com PII sanitization
- [x] Result<T,E> type
- [x] Suite de testes (vitest)
- [x] 35 testes para Circuit Breaker
- [x] Documenta√ß√£o de code review

### Pendentes ‚ö†Ô∏è
- [ ] Cache thread-safe (Issue #2)
- [ ] Rate limiting global (Issue #4)
- [ ] Timeout total para intelligence (Issue #5)
- [ ] Otimizar cache cleanup (Issue #6)
- [ ] Propagar erros (n√£o silenciar) (Issue #7)
- [ ] Implementar ou remover SerpAPI (Issue #8)
- [ ] Valida√ß√£o forte com Zod (Issue #9)
- [ ] Extrair magic numbers (Issue #10)
- [ ] Migrar para Result type (Issue #11)
- [ ] Melhorar type safety (Issue #12)
- [ ] Reorganiza√ß√£o arquitetural (Issue #13)

---

## üöÄ Pr√≥ximos Passos Recomendados

### Curto Prazo (1-2 dias)
1. Instalar depend√™ncias: `npm install`
2. Rodar testes: `npm test`
3. Verificar coverage: `npm run test:coverage`
4. Corrigir Issues #2, #5, #7 (cr√≠ticos para produ√ß√£o)

### M√©dio Prazo (1 semana)
5. Implementar Issues #4, #6, #9
6. Migrar c√≥digo para usar Result type
7. Adicionar mais testes (target: 90% coverage)
8. Implementar ou documentar limita√ß√µes do SerpAPI

### Longo Prazo (2-4 semanas)
9. Reorganiza√ß√£o arquitetural completa
10. Testes de integra√ß√£o end-to-end
11. Benchmarks de performance
12. Documenta√ß√£o t√©cnica completa

---

## üìû Contato

Para d√∫vidas sobre este code review:
- **Email:** cristiano@aredes.me
- **GitHub:** @cristianoaredes
- **Issues:** https://github.com/cristianoaredes/mcp-dadosbr/issues

---

**Data do Review:** 30/09/2025  
**Pr√≥xima Revis√£o Recomendada:** Ap√≥s implementar fixes pendentes
